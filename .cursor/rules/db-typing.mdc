---
description: 
globs: 
alwaysApply: true
---
---
Rule Type: Always
alwaysApply: true
globs:
  - "**/*.sql"
# Database Naming & Typing Enforcement

## Preserve Exact Identifiers
- Nunca altere nomes de tabelas ou colunas. Use sempre o mesmo case e underscores conforme o schema.

## Preserve Data Types
- Nunca altere tipos de dados. Se a coluna for `timestamp without time zone`, `integer`, `boolean`, etc., mantenha exatamente.

## Schema Reference
### Tabela `ai_analysis_history`
- `id` : `integer`
- `ticket_id` : `integer`
- `ai_configuration_id` : `integer`
- `input_title` : `text`
- `input_description` : `text`
- `suggested_priority` : `USER-DEFINED`
- `ai_response_raw` : `text`
- `ai_justification` : `text`
- `provider` : `USER-DEFINED`
- `model` : `text`
- `request_tokens` : `integer`
- `response_tokens` : `integer`
- `processing_time_ms` : `integer`
- `status` : `text`
- `error_message` : `text`
- `retry_count` : `integer`
- `company_id` : `integer`
- `created_at` : `timestamp without time zone`

### Tabela `ai_configurations`
- `id` : `integer`
- `name` : `text`
- `provider` : `USER-DEFINED`
- `model` : `text`
- `api_key` : `text`
- `api_endpoint` : `text`
- `system_prompt` : `text`
- `user_prompt_template` : `text`
- `temperature` : `text`
- `max_tokens` : `integer`
- `timeout_seconds` : `integer`
- `max_retries` : `integer`
- `fallback_priority` : `USER-DEFINED`
- `is_active` : `boolean`
- `is_default` : `boolean`
- `company_id` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `created_by_id` : `integer`
- `updated_by_id` : `integer`

### Tabela `companies`
- `id` : `integer`
- `name` : `text`
- `email` : `text`
- `domain` : `text`
- `active` : `boolean`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `cnpj` : `text`
- `phone` : `text`

### Tabela `customers`
- `id` : `integer`
- `name` : `text`
- `email` : `text`
- `phone` : `text`
- `company` : `text`
- `user_id` : `integer`
- `avatar_url` : `text`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `company_id` : `integer`

### Tabela `departments`
- `id` : `integer`
- `name` : `text`
- `description` : `text`
- `company_id` : `integer`
- `is_active` : `boolean`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`

### Tabela `email_templates`
- `id` : `integer`
- `name` : `text`
- `type` : `USER-DEFINED`
- `description` : `text`
- `subject_template` : `text`
- `html_template` : `text`
- `text_template` : `text`
- `is_active` : `boolean`
- `is_default` : `boolean`
- `available_variables` : `text`
- `company_id` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `created_by_id` : `integer`
- `updated_by_id` : `integer`

### Tabela `incident_types`
- `id` : `integer`
- `name` : `text`
- `value` : `text`
- `department_id` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `company_id` : `integer`
- `is_active` : `boolean`

### Tabela `migrations`
- `id` : `integer`
- `name` : `text`
- `executed_at` : `timestamp without time zone`

### Tabela `official_departments`
- `id` : `integer`
- `official_id` : `integer`
- `department` : `text`
- `created_at` : `timestamp with time zone`

### Tabela `officials`
- `id` : `integer`
- `name` : `text`
- `email` : `text`
- `department` : `USER-DEFINED`
- `user_id` : `integer`
- `is_active` : `boolean`
- `avatar_url` : `text`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `company_id` : `integer`
- `department_id` : `integer`
- `supervisor_id` : `integer`
- `manager_id` : `integer`

### Tabela `sla_definitions`
- `id` : `integer`
- `priority` : `USER-DEFINED`
- `response_time_hours` : `integer`
- `resolution_time_hours` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `company_id` : `integer`

### Tabela `system_settings`
- `id` : `integer`
- `key` : `text`
- `value` : `text`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `company_id` : `integer`

### Tabela `ticket_attachments`
- `id` : `integer`
- `ticket_id` : `integer`
- `user_id` : `integer`
- `filename` : `text`
- `original_filename` : `text`
- `file_size` : `integer`
- `mime_type` : `text`
- `s3_key` : `text`
- `s3_bucket` : `text`
- `uploaded_at` : `timestamp without time zone`
- `is_deleted` : `boolean`
- `deleted_at` : `timestamp without time zone`
- `deleted_by_id` : `integer`

### Tabela `ticket_replies`
- `id` : `integer`
- `ticket_id` : `integer`
- `user_id` : `integer`
- `message` : `text`
- `created_at` : `timestamp without time zone`
- `is_internal` : `boolean`

### Tabela `ticket_status_history`
- `id` : `integer`
- `ticket_id` : `integer`
- `old_status` : `USER-DEFINED`
- `new_status` : `USER-DEFINED`
- `changed_by_id` : `integer`
- `created_at` : `timestamp without time zone`

### Tabela `ticket_types`
- `id` : `integer`
- `name` : `text`
- `value` : `text`
- `description` : `text`
- `department_id` : `integer`
- `company_id` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `is_active` : `boolean`

### Tabela `tickets`
- `id` : `integer`
- `ticket_id` : `text`
- `title` : `text`
- `description` : `text`
- `status` : `USER-DEFINED`
- `priority` : `USER-DEFINED`
- `type` : `text`
- `customer_id` : `integer`
- `customer_email` : `text`
- `assigned_to_id` : `integer`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `first_response_at` : `timestamp without time zone`
- `resolved_at` : `timestamp without time zone`
- `sla_breached` : `boolean`
- `department_id` : `integer`
- `incident_type_id` : `integer`
- `company_id` : `integer`

### Tabela `users`
- `id` : `integer`
- `username` : `text`
- `password` : `text`
- `email` : `text`
- `name` : `text`
- `role` : `USER-DEFINED`
- `avatar_url` : `text`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`
- `active` : `boolean`
- `ad_user` : `boolean`
- `company_id` : `integer`

### Tabela `user_notification_settings`
- `id` : `integer`
- `user_id` : `integer`
- `new_ticket_assigned` : `boolean`
- `ticket_status_changed` : `boolean`
- `new_reply_received` : `boolean`
- `ticket_escalated` : `boolean`
- `ticket_due_soon` : `boolean`
- `new_customer_registered` : `boolean`
- `new_user_created` : `boolean`
- `system_maintenance` : `boolean`
- `email_notifications` : `boolean`
- `notification_hours_start` : `integer`
- `notification_hours_end` : `integer`
- `weekend_notifications` : `boolean`
- `digest_frequency` : `text`
- `created_at` : `timestamp without time zone`
- `updated_at` : `timestamp without time zone`

## Enums Disponíveis

### `ai_provider`
- `openai`
- `google`
- `anthropic`

### `email_template_type`
- `new_ticket`
- `ticket_assigned`
- `ticket_reply`
- `status_changed`
- `ticket_resolved`
- `ticket_escalated`
- `ticket_due_soon`
- `customer_registered`
- `user_created`
- `system_maintenance`

### `ticket_priority` (USER-DEFINED)
- `low`
- `medium`
- `high`
- `urgent`

### `ticket_status` (USER-DEFINED)
- `open`
- `in_progress`
- `pending`
- `resolved`
- `closed`

### `user_role` (USER-DEFINED)
- `admin`
- `support`
- `customer`

## Constraints Importantes

### `system_settings`
- Constraint única composta: (`key`, `company_id`)
- Permite configurações específicas por empresa

### Índices de Performance
- `idx_tickets_company_id` - Otimização para consultas por empresa
- `idx_tickets_status` - Otimização para filtros por status
- `idx_tickets_priority` - Otimização para filtros por prioridade
- `idx_tickets_assigned_to_id` - Otimização para tickets atribuídos
- `idx_tickets_created_at` - Otimização para ordenação temporal
- `idx_users_company_id` - Otimização para usuários por empresa
- `idx_customers_company_id` - Otimização para clientes por empresa
- `idx_officials_company_id` - Otimização para atendentes por empresa
- `idx_departments_company_id` - Otimização para departamentos por empresa
- `idx_system_settings_company_id` - Otimização para configurações por empresa
- `idx_ticket_attachments_ticket_id` - Otimização para anexos por ticket
- `idx_ai_analysis_history_ticket_id` - Otimização para histórico de IA por ticket
- `idx_ai_analysis_history_company_id` - Otimização para histórico de IA por empresa






